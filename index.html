<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Alpha Token Volume Board</title>

<!-- ↓↓↓ Vercel Web Analytics（放在头部即可） ↓↓↓ -->
<script>
  window.va = window.va || function () { (window.vaq = window.vaq || []).push(arguments); };
</script>
<script defer src="/_vercel/insights/script.js"></script>
<!-- ↑↑↑ Vercel Web Analytics ↑↑↑ -->

<style>
:root{
  --bg:#f9fafb;--text:#1f2937;--sub:#6b7280;--border:#e5e7eb;
  --green:#16a34a;--red:#dc2626;--primary:#2563eb
}
@media(prefers-color-scheme:dark){
  :root{--bg:#1e293b;--text:#f3f4f6;--sub:#9ca3af;--border:#334155}
}
*{box-sizing:border-box;margin:0;padding:0}
body{
  font-family:-apple-system,"Segoe UI","PingFang SC",sans-serif;
  background:var(--bg);color:var(--text);line-height:1.5
}
h1{padding:18px 12px;text-align:center;font-size:1.4rem;color:var(--primary)}
#bar{
  max-width:1200px;margin:0 auto 12px;display:flex;gap:8px;align-items:center;
  justify-content:space-between;padding:0 6px
}
#bar-left{flex:1;display:flex;gap:8px;align-items:center}
#bar input{
  flex:1;padding:6px 8px;border:1px solid var(--border);border-radius:4px;font-size:.85rem
}
#bar button{
  padding:6px 12px;font-size:.85rem;border:1px solid var(--border);border-radius:4px;
  background:var(--primary);color:#fff;cursor:pointer
}
#bar button:disabled{background:#9ca3af;cursor:not-allowed}
#bar span{font-size:.8rem;color:var(--sub)}
#author{font-size:.8rem}
#author a{color:var(--primary);text-decoration:none}
#lastUp{font-size:.8rem;color:var(--sub)}
table{
  width:100%;max-width:1200px;margin:0 auto;border-collapse:collapse;min-width:620px
}
th,td{
  padding:10px 6px;border-bottom:1px solid var(--border);
  font-size:.85rem;text-align:left;white-space:nowrap
}
tbody tr:hover{background:rgba(0,0,0,.04);cursor:pointer}
/* ---------- 排序 ---------- */
th.sortable{cursor:pointer;user-select:none;position:relative}
th.sortable::after{
  content:'▲';position:absolute;right:4px;font-size:.6rem;color:var(--sub);transform:scale(.8);
  opacity:.0;transition:opacity .2s
}
th.sortable.desc::after{content:'▼';opacity:1}
th.sortable.asc::after{content:'▲';opacity:1}
/* ---------- Star ---------- */
.star{
  cursor:pointer;font-size:1rem;color:var(--sub);user-select:none;
  transition:transform .15s,color .15s
}
.star.fav{color:#f7b500}
.star.bounce{transform:scale(1.4)}
/* ---------- Icons & 数字色 ---------- */
.logo{width:18px;height:18px;margin-right:4px;vertical-align:middle;border-radius:50%}
.up{color:var(--green)}.down{color:var(--red)}
.subl{display:block;font-size:.72rem;color:var(--sub)}
/* ---------- Toast ---------- */
#toast{
  position:fixed;bottom:40px;left:50%;transform:translateX(-50%);
  background:rgba(0,0,0,.8);color:#fff;padding:8px 16px;border-radius:6px;
  font-size:.85rem;opacity:0;pointer-events:none;transition:opacity .3s
}
footer{height:16px;margin-bottom:12px}
</style>
</head>
<body>
<h1>Binance Alpha — 24H 交易量排行榜</h1>

<div id="bar">
  <div id="bar-left">
    <input id="search" type="search" placeholder="🔍 按代币名称 / 符号过滤…">
    <button id="refreshBtn">⟳ 刷新数据</button>
    <span id="progress"></span>
  </div>
  <div id="author">
    <span id="lastUp"></span>　
    作者 <a href="https://twitter.com/0xXIAOc" target="_blank">@0xXIAOc</a>
  </div>
</div>

<table id="tokenTable">
  <thead>
    <tr>
      <th style="width:26px"></th><th>#</th><th>代币名字</th>
      <th id="thPrice">价格</th>
      <th id="thVol24h" class="sortable" data-key="vol24h">24H 交易量</th>
      <th>24H 变化</th>
      <th id="thToday" class="sortable" data-key="todayQV">当天限价单成交额</th>
      <th id="thPrev" class="sortable" data-key="prevQV">前一天限价单成交额</th>
    </tr>
  </thead>
  <tbody><tr><td colspan="8">加载中…</td></tr></tbody>
</table>

<div id="toast"></div>
<footer></footer>

<script>
/* ---------- 常量 ---------- */
const LIST_API='https://www.binance.com/bapi/defi/v1/public/wallet-direct/buw/wallet/cex/alpha/all/token/list';
const K_API  ='https://www.binance.com/bapi/defi/v1/public/alpha-trade/klines';
const nf0=new Intl.NumberFormat('en-US',{maximumFractionDigits:0});
const nf2=new Intl.NumberFormat('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
const FAV_KEY='alphaFavs',CONCURRENCY=5;

/* ---------- 工具 ---------- */
const fmtShort=ts=>new Intl.DateTimeFormat('zh-CN',
  {timeZone:'Asia/Shanghai',hour12:false,month:'2-digit',day:'2-digit',hour:'2-digit',minute:'2-digit'})
  .format(new Date(ts)).replace(/\//g,'-');
const fmtFull=ts=>new Intl.DateTimeFormat('zh-CN',
  {timeZone:'Asia/Shanghai',hour12:false,year:'numeric',month:'2-digit',day:'2-digit',
  hour:'2-digit',minute:'2-digit',second:'2-digit'})
  .format(new Date(ts)).replace(/\//g,'-');
const nearest8UTC=()=>{
  const now=new Date(), b=new Date();
  b.setHours(8,0,0,0);
  if(now<b) b.setDate(b.getDate()-1);
  return b.getTime();
};

/* ---------- Toast ---------- */
const toast=document.getElementById('toast');
function showToast(msg){
  toast.textContent=msg;
  toast.style.opacity='1';
  setTimeout(()=>toast.style.opacity='0',3000);
}

/* ---------- 状态 ---------- */
let rows=[],filter='',sortKey='vol24h',sortDir='desc';
const tbody=document.querySelector('#tokenTable tbody');
const btnRefresh=document.getElementById('refreshBtn');
const progressEl=document.getElementById('progress');
const lastUpEl=document.getElementById('lastUp');
const thToday=document.getElementById('thToday');
const thPrev=document.getElementById('thPrev');
window._boundary=nearest8UTC();

/* ---------- 并发限制 ---------- */
function pLimit(n){
  const q=[];let run=0;
  const next=()=>{if(run>=n||!q.length)return;run++;q.shift()().finally(()=>{run--;next();});};
  return fn=>new Promise(res=>{q.push(()=>fn().then(res));next();});
}
const limit=pLimit(CONCURRENCY);

/* ---------- QuoteVolume ---------- */
async function qv(sym,start,end){
  if(start>=end) return 0;
  const url=`${K_API}?symbol=${sym}&interval=1h&startTime=${start}&endTime=${end}&limit=1500`;
  try{
    const {data=[]}=await fetch(url).then(r=>r.json());
    return data.reduce((s,k)=>s+parseFloat(k[7]),0);
  }catch{return 0;}
}
async function fillQVAll(list,today8,yest8,endTs){
  let done=0,total=list.length;
  progressEl.textContent='0%';
  await Promise.all(list.map(r=>limit(async()=>{
    [r.todayQV,r.prevQV]=await Promise.all([
      qv(r.sym,today8,endTs),
      qv(r.sym,yest8,today8-1)
    ]);
    progressEl.textContent=`${Math.floor(++done/total*100)}%`;
  })));
  progressEl.textContent='';
}

/* ---------- 收藏 ---------- */
const favs=()=>JSON.parse(localStorage.getItem(FAV_KEY)||'[]');
function toggleFav(sym){
  const f=favs();const i=f.indexOf(sym);
  i>-1?f.splice(i,1):f.push(sym);
  localStorage.setItem(FAV_KEY,JSON.stringify(f));
  showToast(i>-1?'已移除收藏':'已加入收藏');
  render();
}

/* ---------- 数据 ---------- */
async function fetchList(){
  const resp=await fetch(LIST_API);
  if(!resp.ok) throw new Error('LIST_API Error');
  const {data=[]}=await resp.json();
  return data.filter(t=>+t.volume24h>0).map(t=>({
    price:+t.price,vol24h:+t.volume24h,chg:+t.percentChange24h,
    symbol:t.symbol,icon:t.iconUrl,sym:`${t.alphaId}USDT`,
    todayQV:0,prevQV:0
  }));
}

/* ---------- 排序 & 渲染 ---------- */
function sortRows(arr){
  return [...arr].sort((a,b)=>{
    const v1=a[sortKey],v2=b[sortKey];
    return sortDir==='desc'?v2-v1:v1-v2;
  });
}
function updateSortIcons(){
  document.querySelectorAll('th.sortable').forEach(th=>{
    th.classList.remove('asc','desc');
    if(th.dataset.key===sortKey) th.classList.add(sortDir);
  });
}
function render(){
  const favSet=new Set(favs());
  const filtered=rows.filter(r=>r.symbol.toLowerCase().includes(filter)||r.sym.toLowerCase().includes(filter));
  const sorted=sortRows(filtered);
  const display=[...sorted.filter(x=>favSet.has(x.sym)),...sorted.filter(x=>!favSet.has(x.sym))];
  tbody.innerHTML=display.map((t,i)=>`
    <tr data-sym="${t.sym}">
      <td class="star ${favSet.has(t.sym)?'fav':''}">${favSet.has(t.sym)?'★':'☆'}</td>
      <td>${i+1}</td>
      <td><img class="logo" loading="lazy" src="${t.icon}" referrerpolicy="no-referrer"
       onerror="this.src='https://bin.bnbstatic.com/static/images/common/base-token-default.png'">${t.symbol}</td>
      <td>${nf2.format(t.price)}</td>
      <td>${nf0.format(t.vol24h)}</td>
      <td class="${t.chg>=0?'up':'down'}">${t.chg.toFixed(2)}%</td>
      <td>${t.todayQV?nf0.format(t.todayQV):'…'}</td>
      <td>${t.prevQV?nf0.format(t.prevQV):'…'}</td>
    </tr>`).join('');
  updateSortIcons();
}

/* ---------- 刷新 ---------- */
async function reloadAll(){
  btnRefresh.disabled=true;progressEl.textContent='0%';
  const today8=nearest8UTC(), yest8=today8-864e5;
  const endTs=Date.now();
  thToday.innerHTML=`当天限价单成交额<span class="subl">(${fmtShort(today8)} ~ ${fmtShort(endTs)})</span>`;
  thPrev.innerHTML=`前一天限价单成交额<span class="subl">(${fmtShort(yest8)} ~ ${fmtShort(today8-1)})</span>`;
  try{
    rows=await fetchList();
    await fillQVAll(rows,today8,yest8,endTs);
    render();
    lastUpEl.textContent=`最后更新时间：${fmtFull(Date.now())}`;
    window._boundary=today8;
  }catch(err){
    console.error(err);
    tbody.innerHTML='<tr><td colspan="8">加载失败…</td></tr>';
    showToast('加载失败，请稍后重试');
  }finally{
    btnRefresh.disabled=false;
  }
}

/* ---------- 事件 ---------- */
btnRefresh.addEventListener('click',reloadAll);
tbody.addEventListener('click',e=>{
  const star=e.target.closest('.star');
  if(star){
    star.classList.add('bounce');
    setTimeout(()=>star.classList.remove('bounce'),150);
    toggleFav(star.closest('tr').dataset.sym);
  }
});
document.getElementById('search').addEventListener('input',e=>{
  filter=e.target.value.trim().toLowerCase();
  render();
});
document.querySelectorAll('th.sortable').forEach(th=>{
  th.addEventListener('click',()=>{
    const key=th.dataset.key;
    sortDir=(sortKey===key&&sortDir==='desc')?'asc':'desc';
    sortKey=key;
    render();
  });
});

/* ---------- 自动与可见性刷新 ---------- */
document.addEventListener('visibilitychange',()=>{
  if(document.visibilityState==='visible'&&nearest8UTC()!==window._boundary){
    reloadAll();
  }
});
setInterval(()=>{if(document.visibilityState==='visible') reloadAll();},300000);

/* ---------- 初次加载 ---------- */
reloadAll();
</script>
</body>
</html>
